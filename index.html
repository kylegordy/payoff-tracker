<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Payoff Tracker</title>
  <meta name="description" content="See how extra payments can save you thousands in interest and years off your mortgage. Enter your loan details and share the results.">
  <meta property="og:title" content="Home Payoff Tracker">
  <meta property="og:description" content="See how extra payments can save you thousands in interest and years off your mortgage.">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Home Payoff Tracker">
  <meta name="twitter:description" content="See how extra payments can save you thousands in interest and years off your mortgage.">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .subtitle {
      color: #86868b;
      font-size: 15px;
      margin-bottom: 24px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .card h2 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #86868b;
      margin-bottom: 16px;
    }

    .field {
      margin-bottom: 14px;
    }

    .field:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #1d1d1f;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #d2d2d7;
      border-radius: 10px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.2s;
      -webkit-appearance: none;
      background: #fff;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%2386868b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #0071e3;
    }

    .field-hint {
      display: block;
      font-size: 12px;
      color: #86868b;
      margin-top: 4px;
    }

    .derived-info {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 14px;
      margin-top: 14px;
    }

    .derived-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .derived-row + .derived-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e5ea;
    }

    .derived-row .label {
      color: #86868b;
      font-weight: 500;
    }

    .derived-row .value {
      font-weight: 600;
      color: #1d1d1f;
    }

    .total-payment {
      background: #e8f5e9;
      border-radius: 12px;
      padding: 14px;
      margin-top: 14px;
    }

    .total-payment-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #86868b;
      margin-bottom: 4px;
    }

    .total-payment-value {
      font-size: 22px;
      font-weight: 700;
      color: #2e7d32;
    }

    .progress-container {
      margin-top: 14px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .progress-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #86868b;
    }

    .progress-pct {
      font-size: 14px;
      font-weight: 700;
      color: #0071e3;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e5ea;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #0071e3;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stat {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 14px;
    }

    .stat.highlight {
      background: #e8f5e9;
    }

    .stat-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #86868b;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
    }

    .stat.highlight .stat-value {
      color: #2e7d32;
    }

    .stat-detail {
      font-size: 12px;
      color: #86868b;
      margin-top: 2px;
    }

    .chart-container {
      margin-top: 8px;
      position: relative;
      height: 200px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .share-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: #0071e3;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      color: #fff;
      cursor: pointer;
      margin-bottom: 16px;
      transition: background 0.2s;
    }

    .share-btn:active {
      background: #005bb5;
    }

    .share-btn.copied {
      background: #34c759;
    }

    .schedule-toggle {
      display: block;
      width: 100%;
      padding: 12px;
      background: none;
      border: 1.5px solid #d2d2d7;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      color: #0071e3;
      cursor: pointer;
      margin-top: 12px;
    }

    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    .schedule-table.visible {
      display: table;
    }

    .schedule-table th {
      text-align: left;
      font-weight: 600;
      color: #86868b;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      padding: 8px 6px;
      border-bottom: 1px solid #e5e5ea;
    }

    .schedule-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #f0f0f5;
    }

    #no-results {
      text-align: center;
      padding: 40px 20px;
      color: #86868b;
    }
  </style>
</head>
<body>
  <h1>Home Payoff Tracker</h1>
  <p class="subtitle">See how extra payments accelerate your payoff</p>

  <div class="card">
    <h2>Original Loan</h2>
    <div class="field">
      <label for="original">Original Loan Amount</label>
      <input type="text" id="original" inputmode="decimal" placeholder="$400,000">
    </div>
    <div class="field">
      <label for="term">Loan Term</label>
      <select id="term">
        <option value="360">30 years</option>
        <option value="240">20 years</option>
        <option value="180">15 years</option>
        <option value="120">10 years</option>
      </select>
    </div>
    <div class="field">
      <label for="rate">Interest Rate (%)</label>
      <input type="text" id="rate" inputmode="decimal" placeholder="6.5">
    </div>
    <div class="field">
      <label for="startdate">Loan Start Date</label>
      <input type="month" id="startdate" placeholder="2020-03">
    </div>
    <div class="derived-info" id="derived-info" style="display: none;">
      <div class="derived-row">
        <span class="label">P&I Payment</span>
        <span class="value" id="derived-pi">—</span>
      </div>
      <div class="derived-row">
        <span class="label">Total Interest (life of loan)</span>
        <span class="value" id="derived-total-interest">—</span>
      </div>
      <div class="derived-row" id="derived-payoff-row" style="display: none;">
        <span class="label">Original Payoff Date</span>
        <span class="value" id="derived-payoff-date">—</span>
      </div>
      <div class="derived-row" id="derived-elapsed-row" style="display: none;">
        <span class="label">Time into Loan</span>
        <span class="value" id="derived-elapsed">—</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Where You Are Now</h2>
    <div class="field">
      <label for="balance">Current Balance</label>
      <input type="text" id="balance" inputmode="decimal" placeholder="$350,000">
    </div>
    <div class="progress-container" id="progress-container" style="display: none;">
      <div class="progress-header">
        <span class="progress-label">Principal Paid Off</span>
        <span class="progress-pct" id="progress-pct">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Extra Payments</h2>
    <div class="field">
      <label for="escrow">Escrow (taxes & insurance)</label>
      <input type="text" id="escrow" inputmode="decimal" placeholder="$450">
      <span class="field-hint">Optional — not used in payoff math, just for your total payment reference</span>
    </div>
    <div class="field">
      <label for="extra">Extra Monthly Payment</label>
      <input type="text" id="extra" inputmode="decimal" placeholder="$200">
    </div>
    <div class="total-payment" id="total-payment" style="display: none;">
      <div class="total-payment-label">New Monthly Payment</div>
      <div class="total-payment-value" id="total-payment-value"></div>
    </div>
  </div>

  <button class="share-btn" id="share-btn" style="display: none;">Copy Share Link</button>

  <div id="no-results" class="card">
    <p>Enter your loan details above to see your payoff timeline</p>
  </div>

  <div id="results" style="display: none;">
    <div class="card">
      <h2>Payoff Summary</h2>
      <div class="results-grid">
        <div class="stat">
          <div class="stat-label">Original Payoff</div>
          <div class="stat-value" id="orig-date">—</div>
          <div class="stat-detail" id="orig-months">—</div>
        </div>
        <div class="stat highlight">
          <div class="stat-label">With Extra Payments</div>
          <div class="stat-value" id="new-date">—</div>
          <div class="stat-detail" id="new-months">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Remaining Interest</div>
          <div class="stat-value" id="orig-interest">—</div>
          <div class="stat-detail">without extra</div>
        </div>
        <div class="stat highlight">
          <div class="stat-label">Interest Saved</div>
          <div class="stat-value" id="interest-saved">—</div>
          <div class="stat-detail" id="time-saved">—</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Balance Over Time</h2>
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>Amortization Schedule</h2>
      <button class="schedule-toggle" id="schedule-toggle">Show Monthly Breakdown</button>
      <table class="schedule-table" id="schedule-table">
        <thead>
          <tr>
            <th>Month</th>
            <th>Payment</th>
            <th>Principal</th>
            <th>Interest</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody id="schedule-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const STORAGE_KEY = 'payoff-tracker-v2';
    const FIELDS = ['original', 'term', 'rate', 'startdate', 'balance', 'escrow', 'extra'];
    // Short param names for compact URLs
    const PARAM_MAP = { original: 'o', term: 't', rate: 'r', startdate: 'd', balance: 'b', escrow: 's', extra: 'e' };
    const PARAM_MAP_REV = { o: 'original', t: 'term', r: 'rate', d: 'startdate', b: 'balance', s: 'escrow', e: 'extra' };
    // Currency fields get formatted with $
    const CURRENCY_FIELDS = ['original', 'balance', 'escrow', 'extra'];

    // Save current inputs to localStorage
    function saveInputs() {
      const data = {};
      FIELDS.forEach((id) => data[id] = $(id).value);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Load saved inputs from localStorage
    function loadInputs() {
      try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (!data) return false;
        let loaded = false;
        FIELDS.forEach((id) => {
          if (data[id]) {
            $(id).value = data[id];
            loaded = true;
          }
        });
        return loaded;
      } catch {
        return false;
      }
    }

    // Load inputs from URL query params (takes priority over localStorage)
    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      let loaded = false;
      for (const [short, field] of Object.entries(PARAM_MAP_REV)) {
        const val = params.get(short);
        if (val) {
          if (field === 'term' || field === 'startdate') {
            $(field).value = val;
            loaded = true;
          } else {
            const num = parseFloat(val);
            if (!isNaN(num) && num > 0) {
              $(field).value = CURRENCY_FIELDS.includes(field)
                ? '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 })
                : val;
              loaded = true;
            }
          }
        }
      }
      if (loaded) saveInputs();
      return loaded;
    }

    // Build a share URL from current raw values
    function buildShareURL() {
      const url = new URL(window.location.pathname, window.location.origin);
      FIELDS.forEach((id) => {
        if (id === 'term' || id === 'startdate') {
          if ($(id).value) url.searchParams.set(PARAM_MAP[id], $(id).value);
        } else {
          const val = parseNum(id);
          if (val > 0) {
            url.searchParams.set(PARAM_MAP[id], val);
          }
        }
      });
      return url.toString();
    }

    // Parse currency/number input
    function parseNum(id) {
      const val = $(id).value.replace(/[^0-9.]/g, '');
      return parseFloat(val) || 0;
    }

    // Format as currency
    function fmt(n) {
      return '$' + n.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    // Format months as readable duration
    function fmtMonths(m) {
      const years = Math.floor(m / 12);
      const months = m % 12;
      if (years === 0) return `${months} mo`;
      if (months === 0) return `${years} yr`;
      return `${years} yr ${months} mo`;
    }

    // Get payoff date from now
    function payoffDate(months) {
      const d = new Date();
      d.setMonth(d.getMonth() + months);
      return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }

    // Calculate standard monthly P&I payment
    function calcMonthlyPI(principal, annualRate, termMonths) {
      const r = annualRate / 100 / 12;
      if (r === 0) return principal / termMonths;
      return principal * (r * Math.pow(1 + r, termMonths)) / (Math.pow(1 + r, termMonths) - 1);
    }

    // Calculate amortization schedule from a starting balance
    function amortize(balance, annualRate, monthlyPayment) {
      const monthlyRate = annualRate / 100 / 12;
      const schedule = [];
      let remaining = balance;

      for (let i = 1; remaining > 0.01 && i <= 600; i++) {
        const interest = remaining * monthlyRate;
        const principal = Math.min(remaining, monthlyPayment - interest);
        if (principal <= 0) break;
        remaining = Math.max(0, remaining - principal);
        schedule.push({
          month: i,
          payment: principal + interest,
          principal,
          interest,
          balance: remaining,
        });
      }
      return schedule;
    }

    // Draw the chart on canvas
    function drawChart(original, withExtra) {
      const canvas = $('chart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.parentElement.getBoundingClientRect();

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);

      const w = rect.width;
      const h = rect.height;
      const pad = { top: 10, right: 10, bottom: 30, left: 55 };
      const plotW = w - pad.left - pad.right;
      const plotH = h - pad.top - pad.bottom;

      ctx.clearRect(0, 0, w, h);

      const maxMonths = Math.max(original.length, withExtra.length);
      const maxBalance = original.length > 0 ? original[0].balance + original[0].principal : 0;
      if (maxMonths === 0 || maxBalance === 0) return;

      const xScale = plotW / maxMonths;
      const yScale = plotH / maxBalance;

      // Grid lines
      ctx.strokeStyle = '#e5e5ea';
      ctx.lineWidth = 1;
      const gridSteps = 4;
      for (let i = 0; i <= gridSteps; i++) {
        const y = pad.top + (plotH / gridSteps) * i;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(w - pad.right, y);
        ctx.stroke();

        const val = maxBalance - (maxBalance / gridSteps) * i;
        ctx.fillStyle = '#86868b';
        ctx.font = '11px -apple-system, sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(fmt(val), pad.left - 8, y + 4);
      }

      // X-axis labels
      ctx.textAlign = 'center';
      const yearInterval = Math.max(1, Math.ceil(maxMonths / 12 / 5));
      for (let yr = 0; yr <= Math.ceil(maxMonths / 12); yr += yearInterval) {
        const x = pad.left + yr * 12 * xScale;
        if (x <= w - pad.right) {
          ctx.fillText(`Yr ${yr}`, x, h - 8);
        }
      }

      // Draw line helper
      function drawLine(data, color, startBalance) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        ctx.moveTo(pad.left, pad.top + plotH - startBalance * yScale);
        data.forEach((d) => {
          const x = pad.left + d.month * xScale;
          const y = pad.top + plotH - d.balance * yScale;
          ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      const startBal = maxBalance;
      drawLine(original, '#d2d2d7', startBal);
      drawLine(withExtra, '#34c759', startBal);

      // Legend
      ctx.font = '12px -apple-system, sans-serif';
      const legendY = pad.top + 8;
      ctx.fillStyle = '#d2d2d7';
      ctx.fillRect(w - pad.right - 140, legendY - 4, 10, 10);
      ctx.fillStyle = '#86868b';
      ctx.textAlign = 'left';
      ctx.fillText('Original', w - pad.right - 126, legendY + 5);

      ctx.fillStyle = '#34c759';
      ctx.fillRect(w - pad.right - 68, legendY - 4, 10, 10);
      ctx.fillStyle = '#2e7d32';
      ctx.fillText('Extra', w - pad.right - 54, legendY + 5);
    }

    function calculate() {
      const originalLoan = parseNum('original');
      const termMonths = parseInt($('term').value) || 360;
      const rate = parseNum('rate');
      const startDateVal = $('startdate').value; // "YYYY-MM" or ""
      const balance = parseNum('balance');
      const escrow = parseNum('escrow');
      const extra = parseNum('extra');

      // Parse start date
      let startDate = null;
      let elapsedMonths = 0;
      if (startDateVal) {
        const [year, month] = startDateVal.split('-').map(Number);
        startDate = new Date(year, month - 1); // first of that month
        const now = new Date();
        elapsedMonths = (now.getFullYear() - startDate.getFullYear()) * 12
          + (now.getMonth() - startDate.getMonth());
      }

      // Calculate the true P&I payment from original loan terms
      let piPayment = 0;
      let fullScheduleInterest = 0;

      if (originalLoan > 0 && rate > 0) {
        piPayment = calcMonthlyPI(originalLoan, rate, termMonths);
        // Total interest over full life of original loan
        const fullSchedule = amortize(originalLoan, rate, piPayment);
        fullScheduleInterest = fullSchedule.reduce((s, d) => s + d.interest, 0);

        // Show derived info
        $('derived-info').style.display = 'block';
        $('derived-pi').textContent = fmt(piPayment);
        $('derived-total-interest').textContent = fmt(fullScheduleInterest);

        // Show original payoff date and elapsed time if start date provided
        if (startDate) {
          const origPayoff = new Date(startDate);
          origPayoff.setMonth(origPayoff.getMonth() + termMonths);
          $('derived-payoff-row').style.display = 'flex';
          $('derived-payoff-date').textContent = origPayoff.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

          $('derived-elapsed-row').style.display = 'flex';
          $('derived-elapsed').textContent = fmtMonths(elapsedMonths);
        } else {
          $('derived-payoff-row').style.display = 'none';
          $('derived-elapsed-row').style.display = 'none';
        }
      } else {
        $('derived-info').style.display = 'none';
        $('derived-payoff-row').style.display = 'none';
        $('derived-elapsed-row').style.display = 'none';
      }

      // Show progress bar
      if (originalLoan > 0 && balance > 0 && balance <= originalLoan) {
        const paidOff = ((originalLoan - balance) / originalLoan) * 100;
        $('progress-container').style.display = 'block';
        $('progress-pct').textContent = `${Math.round(paidOff)}%`;
        $('progress-fill').style.width = `${paidOff}%`;
      } else {
        $('progress-container').style.display = 'none';
      }

      // Show new monthly payment total
      const totalMonthly = piPayment + escrow + extra;
      if (totalMonthly > 0 && extra > 0) {
        $('total-payment').style.display = 'block';
        $('total-payment-value').textContent = `${fmt(totalMonthly)}/mo`;
      } else {
        $('total-payment').style.display = 'none';
      }

      // Need all core inputs to show results
      if (originalLoan <= 0 || rate <= 0 || balance <= 0 || piPayment <= 0) {
        $('results').style.display = 'none';
        $('share-btn').style.display = 'none';
        $('no-results').style.display = 'block';
        $('no-results').querySelector('p').textContent =
          'Enter your loan details above to see your payoff timeline';
        return;
      }

      // Check P&I covers interest on current balance
      const minPayment = balance * (rate / 100 / 12);
      if (piPayment <= minPayment) {
        $('results').style.display = 'none';
        $('share-btn').style.display = 'none';
        $('no-results').style.display = 'block';
        $('no-results').querySelector('p').textContent =
          `P&I payment (${fmt(piPayment)}) doesn't cover monthly interest (${fmt(Math.ceil(minPayment))}). Check your inputs.`;
        return;
      }

      $('no-results').style.display = 'none';
      $('results').style.display = 'block';
      $('share-btn').style.display = 'block';

      // Original: current balance at P&I payment (no extra)
      const original = amortize(balance, rate, piPayment);
      // With extra: current balance at P&I + extra
      const withExtra = amortize(balance, rate, piPayment + extra);

      const origRemaining = original.reduce((s, d) => s + d.interest, 0);
      const extraRemaining = withExtra.reduce((s, d) => s + d.interest, 0);

      // Original payoff: use true date from start + term if available
      if (startDate) {
        const origPayoff = new Date(startDate);
        origPayoff.setMonth(origPayoff.getMonth() + termMonths);
        $('orig-date').textContent = origPayoff.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        const remainingOrigMonths = termMonths - elapsedMonths;
        $('orig-months').textContent = `${fmtMonths(Math.max(0, remainingOrigMonths))} left`;
      } else {
        $('orig-date').textContent = payoffDate(original.length);
        $('orig-months').textContent = fmtMonths(original.length);
      }
      $('orig-interest').textContent = fmt(origRemaining);

      if (extra > 0) {
        $('new-date').textContent = payoffDate(withExtra.length);
        $('new-months').textContent = fmtMonths(withExtra.length);
        $('interest-saved').textContent = fmt(origRemaining - extraRemaining);
        $('time-saved').textContent = `${fmtMonths(original.length - withExtra.length)} sooner`;
      } else {
        $('new-date').textContent = '—';
        $('new-months').textContent = 'Add extra to compare';
        $('interest-saved').textContent = '—';
        $('time-saved').textContent = 'Add extra to see savings';
      }

      drawChart(original, withExtra);

      // Amortization table (with extra payments, or original if no extra)
      const displaySchedule = extra > 0 ? withExtra : original;
      const tbody = $('schedule-body');
      tbody.innerHTML = '';
      displaySchedule.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.month}</td>
          <td>${fmt(row.payment)}</td>
          <td>${fmt(row.principal)}</td>
          <td>${fmt(row.interest)}</td>
          <td>${fmt(row.balance)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Auto-format currency inputs
    ['original', 'balance', 'escrow', 'extra'].forEach((id) => {
      $(id).addEventListener('blur', function () {
        const val = parseFloat(this.value.replace(/[^0-9.]/g, ''));
        if (!isNaN(val) && val > 0) {
          this.value = '$' + val.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
      });
    });

    // Recalculate on any input change, and save to localStorage
    document.querySelectorAll('input, select').forEach((input) => {
      input.addEventListener('input', () => {
        saveInputs();
        calculate();
      });
      input.addEventListener('change', () => {
        saveInputs();
        calculate();
      });
    });

    // Also save formatted values on blur
    ['original', 'balance', 'escrow', 'extra'].forEach((id) => {
      $(id).addEventListener('blur', () => saveInputs());
    });

    // Toggle schedule
    $('schedule-toggle').addEventListener('click', function () {
      const table = $('schedule-table');
      const visible = table.classList.toggle('visible');
      this.textContent = visible ? 'Hide Monthly Breakdown' : 'Show Monthly Breakdown';
    });

    // Share button — build URL and copy to clipboard
    $('share-btn').addEventListener('click', function () {
      const url = buildShareURL();
      navigator.clipboard.writeText(url).then(() => {
        this.textContent = 'Copied!';
        this.classList.add('copied');
        setTimeout(() => {
          this.textContent = 'Copy Share Link';
          this.classList.remove('copied');
        }, 2000);
      }).catch(() => {
        prompt('Copy this link:', url);
      });
    });

    // Redraw chart on resize
    window.addEventListener('resize', calculate);

    // Load data on page load: URL params take priority, then localStorage
    const loaded = loadFromURL() || loadInputs();
    if (loaded) {
      calculate();
    }
  </script>
</body>
</html>
